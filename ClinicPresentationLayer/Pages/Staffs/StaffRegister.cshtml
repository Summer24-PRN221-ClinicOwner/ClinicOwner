@page
@using BusinessObjects
@using BusinessObjects.Entities
@model ClinicPresentationLayer.Pages.StaffRegisterModel
@{
}
<body class="auth">
    <div id="main-wrapper" class="show">
        <!-- Register page -->
        <div class="login-tabib">
            <div>
                <div class="text-center">
                    <a class="logo" href="index.html">
                        <img class="img-fluid" src="~/images/logo.png" alt="login page">
                    </a>
                </div>
                <h4>Search for a patient</h4>
                <form class="theme-form" method="post" asp-page-handler="Search">
                    <div class="form-group">
                        <label for="SearchTerm" class="control-label">Search Term</label>
                        <input id="SearchTerm" name="SearchTerm" class="form-control" />
                        <span class="text-danger"></span>
                    </div>
                    <button type="submit" class="btn btn-primary">Search</button>
                </form>
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger">
                        @TempData["ErrorMessage"]
                    </div>
                }
                @if (Model.FoundPatient != null)
                {
                    <div>
                        <h4>Patient Details</h4>
                        <p>Name: @Model.FoundPatient.Name</p>
                        <p>Email: @Model.FoundPatient.Email</p>
                        <p>Date of Birth: @Model.FoundPatient.DateOfBirth</p>
                        <p>Gender: @Model.FoundPatient.Gender</p>
                        <p>Phone: @Model.FoundPatient.Phone</p>
                        <p>Address: @Model.FoundPatient.Address</p>
                    </div>
                    <div class="row">
                        <form id="combinedForm" method="post" asp-page-handler="Submit">
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <div class="form-group">
                                <select class="form-control" asp-for="Appointment.ServiceId">
                                    @foreach (var service in Model.Services)
                                    {
                                        <option value="@service.Id">@service.Name</option>
                                    }
                                </select>
                                <span asp-validation-for="Appointment.ServiceId" class="text-danger"></span>
                            </div>


                            <div class="form-group">
                                <label asp-for="Appointment.AppointDate" class="control-label">Appointment Date</label>
                                <input type="date" asp-for="Appointment.AppointDate" class="form-control" id="Appointment_AppointDate" onchange="updateAvailableSlots();" min="" min="@DateTime.Now.ToString("yyyy-MM-dd")" max="@DateTime.Now.AddYears(5).ToString("yyyy-MM-dd")" />
                                <span asp-validation-for="Appointment.AppointDate" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Appointment.StartSlot" class="control-label">Start Slot</label>
                                <select id="appointment-slots-partial" asp-for="Appointment.StartSlot" class="form-control" onchange="updateAvailableDentists()">
                                    @* Populate slots dynamically based on appointment date and service *@
                                    @await Html.PartialAsync("_SlotPartial", new List<Slot>())
                                </select>
                                <span asp-validation-for="Appointment.StartSlot" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Appointment.DentistId" class="control-label">Dentist</label>
                                <select id="dentist-list" asp-for="Appointment.DentistId" class="form-control">
                                    @* Populate dentists dynamically based on selected slot and service *@
                                    @await Html.PartialAsync("_DentistPartial", new List<Dentist>())
                                </select>
                                <span asp-validation-for="Appointment.DentistId" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">Submit Appointment</button>
                            </div>
                        </form>
                    </div>
                }
                else
                {
                    <div class="login-main">
                        <h4>Create your patient account</h4>
                        <p>Enter your personal details to create an account</p>
                        <form class="theme-form" method="post" asp-page-handler="Register">
                            <div class="form-group">
                                <label asp-for="Username" class="control-label"></label>
                                <input asp-for="Username" class="form-control" />
                                <span asp-validation-for="Username" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Password" class="control-label"></label>
                                <input asp-for="Password" class="form-control" type="password" />
                                <span asp-validation-for="Password" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Name" class="control-label"></label>
                                <input asp-for="Name" class="form-control" />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Email" class="control-label"></label>
                                <input asp-for="Email" class="form-control" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="DateOfBirth" class="control-label"></label>
                                <input asp-for="DateOfBirth" class="form-control" type="date" />
                                <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Gender" class="control-label"></label>
                                <select asp-for="Gender" class="form-control">
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                                <span asp-validation-for="Gender" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Phone" class="control-label"></label>
                                <input asp-for="Phone" class="form-control" />
                                <span asp-validation-for="Phone" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Address" class="control-label"></label>
                                <input asp-for="Address" class="form-control" />
                                <span asp-validation-for="Address" class="text-danger"></span>
                            </div>
                            <button type="submit" class="btn btn-primary">Register</button>
                        </form>
                    </div>
                }
        </div>
    </div>
</body>
<script>
    function updateAvailableSlots() {
        var appointmentDate = $('#Appointment_AppointDate').val();
        var serviceDuration = @Model.Service.Duration;

        $.ajax({
            url: '@Url.Page("./StaffRegister", new { handler = "AvailableSlotsPartial" })',
            type: 'GET',
            data: { appointmentDate: appointmentDate, serviceDuration: serviceDuration },
            success: function (data) {
                $('#appointment-slots-partial').html(data);
                updateAvailableDentists();
                console.log(data);
            },
            error: function (xhr, status, error) {
                console.error('Error updating available slots:', error);
            }
        });
        updateAvailableDentists();
    }

    function updateAvailableDentists() {
        var appointmentDate = $('#Appointment_AppointDate').val();
        var serviceDuration = @Model.Service.Duration;
        var startSlot = $('#appointment-slots-partial').val();
        var serviceId = @Model.Service.Id;

        $.ajax({
            url: '@Url.Page("./StaffRegister", new { handler = "AvailableDentistsPartial" })',
            type: 'GET',
            data: {
                appointmentDate: appointmentDate,
                serviceDuration: serviceDuration,
                startSlot: startSlot,
                serviceId: serviceId
            },
            success: function (data) {
                $('#dentist-list').html(data);
                console.log(data);
            },
            error: function (xhr, status, error) {
                console.error('Error retrieving available dentists:', error);
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('Appointment_AppointDate').setAttribute('min', today);
    });
</script>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}

